<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ù†ØµÙ‘Ø© - TeleSat Multi Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <style>
    :root { --bg:#020617;--card:#0b1120;--accent:#22d3ee;--accent2:#a855f7;--text:#e5e7eb;--muted:#9ca3af;--danger:#ef4444;--success:#10b981; }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:"Tajawal",system-ui;background:radial-gradient(circle at top,#0f172a 0,transparent 55%),radial-gradient(circle at bottom,#020617 0,#000 70%);color:var(--text);min-height:100vh;padding:16px;}
    .shell{max-width:900px;margin:0 auto;}
    header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-radius:16px;background:radial-gradient(circle at left,rgba(8,47,73,.95),rgba(15,23,42,.9));border:1px solid rgba(94,234,212,.4);box-shadow:0 0 22px rgba(34,211,238,.3);margin-bottom:18px;}
    .brand{display:flex;align-items:center;gap:10px}
    .brand-logo{width:40px;height:40px;border-radius:16px;background:radial-gradient(circle at top,#22d3ee,#0f172a);display:flex;align-items:center;justify-content:center;box-shadow:0 0 22px rgba(34,211,238,.8);color:#fff;}
    .brand-text span:first-child{font-size:15px;font-weight:700;letter-spacing:.08em}
    .brand-text span:last-child{font-size:11px;color:var(--muted)}
    .card{background:radial-gradient(circle at top left,rgba(15,118,110,.25),transparent 55%),var(--card);border-radius:16px;border:1px solid rgba(51,65,85,.9);padding:16px;box-shadow:0 0 24px rgba(15,23,42,.9);margin-bottom:14px;}
    h2{font-size:16px;margin-bottom:8px;display:flex;align-items:center;gap:6px}
    h2 i{color:var(--accent)}
    label{font-size:12px;color:var(--muted);margin-bottom:3px;display:block;}
    input,select,textarea{width:100%;border-radius:10px;border:1px solid #1f2937;background:#020617;padding:8px;font-size:13px;color:var(--text);margin-bottom:8px;font-family:inherit;}
    textarea{min-height:60px;}
    .row{display:flex;gap:10px}
    .row>div{flex:1}
    button{font-family:inherit;cursor:pointer}
    .btn-main{border:none;border-radius:999px;padding:8px 16px;font-size:13px;background-image:linear-gradient(135deg,var(--accent),var(--accent2));color:#020617;font-weight:600;display:inline-flex;align-items:center;gap:6px;}
    .btn-secondary{border-radius:999px;border:1px solid rgba(148,163,184,.8);padding:6px 12px;font-size:12px;background:transparent;color:var(--muted);}
    table{width:100%;border-collapse:collapse;font-size:12px;margin-top:8px;}
    th,td{border-bottom:1px solid #1f2937;padding:6px 4px;text-align:right;}
    th{color:var(--muted);font-weight:500;}
    .badge{border-radius:999px;padding:3px 8px;font-size:10px;border:1px solid;}
    .b-active{color:var(--success);border-color:var(--success);background:rgba(16,185,129,0.12);}
    .b-stop{color:var(--danger);border-color:var(--danger);background:rgba(239,68,68,0.12);}
    .store-link{font-size:11px;color:var(--accent);word-break:break-all;}
    .toast-container{position:fixed;bottom:12px;right:50%;transform:translateX(50%);z-index:60;display:flex;flex-direction:column;gap:6px;align-items:center;}
    .toast{min-width:220px;max-width:90vw;border-radius:999px;padding:6px 12px;font-size:12px;background:rgba(15,23,42,.96);border:1px solid rgba(148,163,184,.8);display:flex;align-items:center;gap:6px;color:var(--text);}
    .toast-error{border-color:var(--danger);}
    .overlay{position:fixed;inset:0;background:rgba(15,23,42,.9);display:flex;align-items:center;justify-content:center;z-index:80;}
    .overlay-card{background:var(--card);border-radius:16px;border:1px solid var(--accent);padding:18px;width:min(360px,92vw);box-shadow:0 0 28px rgba(34,211,238,.5);}
    .overlay-card h3{margin-bottom:10px;font-size:16px;}
  </style>
</head>
<body>
<div class="shell">
  <header>
    <div class="brand">
      <div class="brand-logo"><i class="fa-solid fa-satellite-dish"></i></div>
      <div class="brand-text">
        <span>TELESAT PANEL</span>
        <span>Ù„ÙˆØ­Ø© ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ù†ØµÙ‘Ø©</span>
      </div>
    </div>
    <button class="btn-secondary" id="logoutMaster" style="display:none;"><i class="fa-solid fa-right-from-bracket"></i> Ø®Ø±ÙˆØ¬</button>
  </header>

  <div class="card" id="createCard" style="display:none;">
    <h2><i class="fa-solid fa-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ù…ØªØ¬Ø± Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¹Ù…ÙŠÙ„</h2>
    <p style="font-size:11px;color:var(--muted);margin-bottom:10px;">
      Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ØªØ¬Ø± ÙˆØ£Ø±Ø³Ù„Ù‡ Ù„Ù„Ø¹Ù…ÙŠÙ„. Ø£ÙˆÙ„ Ù…Ø±Ø© ÙŠØ¯Ø®Ù„ ÙŠÙ„Ø§Ù‚ÙŠ Ø§Ù„Ù…ØªØ¬Ø± ÙØ§Ø±ØºØŒ ÙŠØ¶ØºØ· Ø²Ø± Ø§Ù„Ù…Ø´Ø±Ù ÙˆÙŠØ¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆØ§Ù„Ø±Ù…Ø² Ø§Ù„Ù„ÙŠ ØªØ­Ø¯Ø¯Ù‡Ù… Ø¥Ù„Ù‡.
    </p>
    <div class="row">
      <div>
        <label>Store ID (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ Ø¨Ø¯ÙˆÙ† ÙØ±Ø§ØºØ§Øª)</label>
        <input id="storeIdInput" placeholder="Ù…Ø«Ø§Ù„: telesat1" />
      </div>
      <div>
        <label>Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø± (ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±)</label>
        <input id="storeNameInput" placeholder="Ù…Ø«Ø§Ù„: TeleSat Basra" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ ØµØ§Ø­Ø¨ Ø§Ù„Ù…ØªØ¬Ø± (Ø¨Ø¯ÙˆÙ† +)</label>
        <input id="storeWhatsInput" placeholder="9647xxxxxxxx" />
      </div>
      <div>
        <label>Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† Ù„Ù„Ù…ØªØ¬Ø±</label>
        <input id="storeEmailInput" type="email" placeholder="client@email.com" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>Ø±Ù…Ø² Ø§Ù„Ø£Ø¯Ù…Ù† Ù„Ù„Ù…ØªØ¬Ø± (Password)</label>
        <input id="storePassInput" type="text" placeholder="Ù…Ø«Ø§Ù„: 123456" />
      </div>
      <div>
        <label>Ø±Ø§Ø¨Ø· Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ØªØ¬Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input id="storeLogoInput" placeholder="https://.../logo.png" />
      </div>
    </div>
    <button class="btn-main" id="createStoreBtn"><i class="fa-solid fa-check"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ØªØ¬Ø±</button>
    <p id="createResult" style="font-size:11px;color:var(--accent);margin-top:8px;"></p>
  </div>

  <div class="card" id="listCard" style="display:none;">
    <h2><i class="fa-solid fa-store"></i> Ø§Ù„Ù…ØªØ§Ø¬Ø± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©</h2>
    <p style="font-size:11px;color:var(--muted);margin-bottom:8px;">
      ÙŠÙ…ÙƒÙ†Ùƒ Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ Ù…ØªØ¬Ø± Ù„Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¹Ù„Ù‰ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ. Ø¹Ù†Ø¯ Ø§Ù„Ø¥ÙŠÙ‚Ø§ÙØŒ Ø§Ù„Ù…ØªØ¬Ø± ÙŠÙØªØ­ Ù„ÙƒÙ† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª ØªØªÙˆÙ‚Ù.
    </p>
    <table>
      <thead>
        <tr>
          <th>Ø§Ù„Ù…Ø¹Ø±Ù</th>
          <th>Ø§Ù„Ø¥Ø³Ù…</th>
          <th>ÙˆØ§ØªØ³Ø§Ø¨</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th>Ø§Ù„Ø±Ø§Ø¨Ø·</th>
          <th>ØªØ­ÙƒÙ…</th>
        </tr>
      </thead>
      <tbody id="storesTableBody"></tbody>
    </table>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<!-- Ø´Ø§Ø´Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ù†ØµØ© -->
<div class="overlay" id="masterOverlay">
  <div class="overlay-card">
    <h3><i class="fa-solid fa-lock"></i> Ø¯Ø®ÙˆÙ„ ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ù†ØµÙ‘Ø©</h3>
    <p style="font-size:11px;color:var(--muted);margin-bottom:10px;">
      Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ. Ù„Ø§ ØªØ¹Ø·Ù‡ Ù„Ø£ÙŠ Ø¹Ù…ÙŠÙ„.
    </p>
    <label>Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ</label>
    <input id="masterCodeInput" type="password" placeholder="********" />
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px;">
      <button class="btn-main" id="masterLoginBtn"><i class="fa-solid fa-arrow-right-to-bracket"></i> Ø¯Ø®ÙˆÙ„</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script>
  // Ù…ÙØ§ØªÙŠØ­ Firebase Ù†ÙØ³Ù‡Ø§
  const firebaseConfig = {
    apiKey: "AIzaSyAEX8BjlYjsHOxDwD-Wu9qyFyIR3Wb6RxQ",
    authDomain: "mtgr-24718.firebaseapp.com",
    projectId: "mtgr-24718",
    storageBucket: "mtgr-24718.firebasestorage.app",
    messagingSenderId: "385919783070",
    appId: "1:385919783070:web:64f2703ec8cc0fd1c5ab8f"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ğŸ” Ø±Ù…Ø² ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ù†ØµÙ‘Ø© (ØºÙŠÙ‘Ø±Ù‡ Ø¥Ù†Øª)
  const MASTER_ADMIN_CODE = "999999";

  const storeIdInput   = document.getElementById("storeIdInput");
  const storeNameInput = document.getElementById("storeNameInput");
  const storeWhatsInput= document.getElementById("storeWhatsInput");
  const storeEmailInput= document.getElementById("storeEmailInput");
  const storePassInput = document.getElementById("storePassInput");
  const storeLogoInput = document.getElementById("storeLogoInput");
  const createBtn      = document.getElementById("createStoreBtn");
  const createResult   = document.getElementById("createResult");
  const storesTableBody= document.getElementById("storesTableBody");
  const toastContainer = document.getElementById("toastContainer");
  const masterOverlay  = document.getElementById("masterOverlay");
  const masterInput    = document.getElementById("masterCodeInput");
  const masterLoginBtn = document.getElementById("masterLoginBtn");
  const logoutMaster   = document.getElementById("logoutMaster");
  const createCard     = document.getElementById("createCard");
  const listCard       = document.getElementById("listCard");

  function showToast(msg, type="success") {
    const div = document.createElement("div");
    div.className = "toast" + (type === "error" ? " toast-error" : "");
    div.innerHTML = `<span>${msg}</span>`;
    toastContainer.appendChild(div);
    setTimeout(()=>div.remove(),2500);
  }

  function getBaseStoreUrl() {
    // ÙŠØ±Ø¬Ø¹ Ø±Ø§Ø¨Ø· index.html ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯
    const loc = window.location;
    const path = loc.pathname.replace("owner-admin.html","index.html");
    return loc.origin + path;
  }

  // Ø¯Ø®ÙˆÙ„ ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ù†ØµØ©
  function unlockPanel() {
    masterOverlay.style.display = "none";
    createCard.style.display = "block";
    listCard.style.display = "block";
    logoutMaster.style.display = "inline-flex";
    loadStores();
  }

  masterLoginBtn.addEventListener("click", () => {
    const val = masterInput.value.trim();
    if (val === MASTER_ADMIN_CODE) {
      localStorage.setItem("master_ok","1");
      unlockPanel();
      showToast("Ø£Ù‡Ù„Ø§Ù‹ Ø¨ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ù†ØµÙ‘Ø© âœ…");
    } else {
      showToast("Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­", "error");
    }
  });

  logoutMaster.addEventListener("click", () => {
    localStorage.removeItem("master_ok");
    location.reload();
  });

  // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¥Ø°Ø§ Ø³Ø¨Ù‚ Ø³Ø¬Ù‘Ù„
  if (localStorage.getItem("master_ok") === "1") {
    unlockPanel();
  }

  // Ø¥Ù†Ø´Ø§Ø¡ Ù…ØªØ¬Ø± Ø¬Ø¯ÙŠØ¯
  createBtn.addEventListener("click", async () => {
    let id   = storeIdInput.value.trim().toLowerCase();
    const name  = storeNameInput.value.trim();
    const whats = storeWhatsInput.value.trim();
    const email = storeEmailInput.value.trim();
    const pass  = storePassInput.value.trim();
    const logo  = storeLogoInput.value.trim();

    if (!id) {
      showToast("Ø£Ø¯Ø®Ù„ Store ID", "error");return;
    }
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù€ ID
    id = id.replace(/\s+/g,"-").replace(/[^a-z0-9\-]/g,"");

    if (!email || !pass) {
      showToast("Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† ÙˆØ§Ù„Ø±Ù…Ø² Ø¶Ø±ÙˆØ±ÙŠØ§Ù†", "error");return;
    }

    createBtn.disabled = true;
    createBtn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...";

    try {
      const docRef = db.collection("stores").doc(id);
      const snap = await docRef.get();
      if (snap.exists) {
        showToast("ÙŠÙˆØ¬Ø¯ Ù…ØªØ¬Ø± Ø¨Ù†ÙØ³ Ø§Ù„Ù…Ø¹Ø±ÙØŒ Ø§Ø®ØªØ± Ù…Ø¹Ø±Ù Ø¢Ø®Ø±", "error");
      } else {
        await docRef.set({
          name: name || id,
          whatsapp: whats || null,
          adminEmail: email,
          adminPassword: pass,
          logoUrl: logo || null,
          active: true,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        const link = getBaseStoreUrl() + "?store=" + id;
        createResult.textContent = "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ØªØ¬Ø±. Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ù…ÙŠÙ„: " + link;
        showToast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ØªØ¬Ø± âœ…");
        storeIdInput.value = storeNameInput.value = storeWhatsInput.value =
          storeEmailInput.value = storePassInput.value = storeLogoInput.value = "";
      }
    } catch (e) {
      console.error(e);
      showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡", "error");
    } finally {
      createBtn.disabled = false;
      createBtn.innerHTML = '<i class="fa-solid fa-check"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ØªØ¬Ø±';
    }
  });

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØ§Ø¬Ø± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
  function loadStores() {
    db.collection("stores").orderBy("createdAt","desc").onSnapshot(snap => {
      storesTableBody.innerHTML = "";
      if (snap.empty) {
        storesTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;font-size:11px;color:var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØªØ§Ø¬Ø± Ø¨Ø¹Ø¯.</td></tr>';
        return;
      }
      snap.forEach(doc => {
        const d = doc.data();
        const id = doc.id;
        const link = getBaseStoreUrl() + "?store=" + id;
        const tr = document.createElement("tr");
        const active = d.active !== false;

        tr.innerHTML = `
          <td>${id}</td>
          <td>${d.name || "-"}</td>
          <td>${d.whatsapp || "-"}</td>
          <td>
            <span class="badge ${active?'b-active':'b-stop'}">
              ${active ? 'Ù†Ø´Ø·' : 'Ù…ÙˆÙ‚ÙˆÙ'}
            </span>
          </td>
          <td><div class="store-link">${link}</div></td>
          <td>
            <button class="btn-secondary" style="font-size:11px;margin-bottom:4px;"
              onclick="copyLink('${link}')">
              <i class="fa-solid fa-copy"></i> Ù†Ø³Ø®
            </button><br/>
            <button class="btn-secondary" style="font-size:11px;color:${active?'#ef4444':'#10b981'};border-color:${active?'#ef4444':'#10b981'}"
              onclick="toggleStoreActive('${id}', ${active?'false':'true'})">
              ${active ? 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…ØªØ¬Ø±' : 'ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ØªØ¬Ø±'}
            </button>
          </td>
        `;
        storesTableBody.appendChild(tr);
      });
    });
  }

  // Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·
  window.copyLink = function(link) {
    navigator.clipboard.writeText(link).then(()=>{
      showToast("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· âœ…");
    }).catch(()=>showToast("ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø®", "error"));
  };

  // ØªÙØ¹ÙŠÙ„ / Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…ØªØ¬Ø±
  window.toggleStoreActive = async function(id, newState) {
    try {
      await db.collection("stores").doc(id).update({active:newState});
      showToast(newState ? "ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ØªØ¬Ø±" : "ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…ØªØ¬Ø±");
    } catch(e) {
      console.error(e);
      showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«", "error");
    }
  };
</script>
</body>
</html>
